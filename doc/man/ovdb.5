.\" Automatically generated by Pod::Man 4.07 (Pod::Simple 3.32)
.\"
.\" Standard preamble:
.\" ========================================================================
.de Sp \" Vertical space (when we can't use .PP)
.if t .sp .5v
.if n .sp
..
.de Vb \" Begin verbatim text
.ft CW
.nf
.ne \\$1
..
.de Ve \" End verbatim text
.ft R
.fi
..
.\" Set up some character translations and predefined strings.  \*(-- will
.\" give an unbreakable dash, \*(PI will give pi, \*(L" will give a left
.\" double quote, and \*(R" will give a right double quote.  \*(C+ will
.\" give a nicer C++.  Capital omega is used to do unbreakable dashes and
.\" therefore won't be available.  \*(C` and \*(C' expand to `' in nroff,
.\" nothing in troff, for use with C<>.
.tr \(*W-
.ds C+ C\v'-.1v'\h'-1p'\s-2+\h'-1p'+\s0\v'.1v'\h'-1p'
.ie n \{\
.    ds -- \(*W-
.    ds PI pi
.    if (\n(.H=4u)&(1m=24u) .ds -- \(*W\h'-12u'\(*W\h'-12u'-\" diablo 10 pitch
.    if (\n(.H=4u)&(1m=20u) .ds -- \(*W\h'-12u'\(*W\h'-8u'-\"  diablo 12 pitch
.    ds L" ""
.    ds R" ""
.    ds C` ""
.    ds C' ""
'br\}
.el\{\
.    ds -- \|\(em\|
.    ds PI \(*p
.    ds L" ``
.    ds R" ''
.    ds C`
.    ds C'
'br\}
.\"
.\" Escape single quotes in literal strings from groff's Unicode transform.
.ie \n(.g .ds Aq \(aq
.el       .ds Aq '
.\"
.\" If the F register is >0, we'll generate index entries on stderr for
.\" titles (.TH), headers (.SH), subsections (.SS), items (.Ip), and index
.\" entries marked with X<> in POD.  Of course, you'll have to process the
.\" output yourself in some meaningful fashion.
.\"
.\" Avoid warning from groff about undefined register 'F'.
.de IX
..
.if !\nF .nr F 0
.if \nF>0 \{\
.    de IX
.    tm Index:\\$1\t\\n%\t"\\$2"
..
.    if !\nF==2 \{\
.        nr % 0
.        nr F 2
.    \}
.\}
.\"
.\" Accent mark definitions (@(#)ms.acc 1.5 88/02/08 SMI; from UCB 4.2).
.\" Fear.  Run.  Save yourself.  No user-serviceable parts.
.    \" fudge factors for nroff and troff
.if n \{\
.    ds #H 0
.    ds #V .8m
.    ds #F .3m
.    ds #[ \f1
.    ds #] \fP
.\}
.if t \{\
.    ds #H ((1u-(\\\\n(.fu%2u))*.13m)
.    ds #V .6m
.    ds #F 0
.    ds #[ \&
.    ds #] \&
.\}
.    \" simple accents for nroff and troff
.if n \{\
.    ds ' \&
.    ds ` \&
.    ds ^ \&
.    ds , \&
.    ds ~ ~
.    ds /
.\}
.if t \{\
.    ds ' \\k:\h'-(\\n(.wu*8/10-\*(#H)'\'\h"|\\n:u"
.    ds ` \\k:\h'-(\\n(.wu*8/10-\*(#H)'\`\h'|\\n:u'
.    ds ^ \\k:\h'-(\\n(.wu*10/11-\*(#H)'^\h'|\\n:u'
.    ds , \\k:\h'-(\\n(.wu*8/10)',\h'|\\n:u'
.    ds ~ \\k:\h'-(\\n(.wu-\*(#H-.1m)'~\h'|\\n:u'
.    ds / \\k:\h'-(\\n(.wu*8/10-\*(#H)'\z\(sl\h'|\\n:u'
.\}
.    \" troff and (daisy-wheel) nroff accents
.ds : \\k:\h'-(\\n(.wu*8/10-\*(#H+.1m+\*(#F)'\v'-\*(#V'\z.\h'.2m+\*(#F'.\h'|\\n:u'\v'\*(#V'
.ds 8 \h'\*(#H'\(*b\h'-\*(#H'
.ds o \\k:\h'-(\\n(.wu+\w'\(de'u-\*(#H)/2u'\v'-.3n'\*(#[\z\(de\v'.3n'\h'|\\n:u'\*(#]
.ds d- \h'\*(#H'\(pd\h'-\w'~'u'\v'-.25m'\f2\(hy\fP\v'.25m'\h'-\*(#H'
.ds D- D\\k:\h'-\w'D'u'\v'-.11m'\z\(hy\v'.11m'\h'|\\n:u'
.ds th \*(#[\v'.3m'\s+1I\s-1\v'-.3m'\h'-(\w'I'u*2/3)'\s-1o\s+1\*(#]
.ds Th \*(#[\s+2I\s-2\h'-\w'I'u*3/5'\v'-.3m'o\v'.3m'\*(#]
.ds ae a\h'-(\w'a'u*4/10)'e
.ds Ae A\h'-(\w'A'u*4/10)'E
.    \" corrections for vroff
.if v .ds ~ \\k:\h'-(\\n(.wu*9/10-\*(#H)'\s-2\u~\d\s+2\h'|\\n:u'
.if v .ds ^ \\k:\h'-(\\n(.wu*10/11-\*(#H)'\v'-.4m'^\v'.4m'\h'|\\n:u'
.    \" for low resolution devices (crt and lpr)
.if \n(.H>23 .if \n(.V>19 \
\{\
.    ds : e
.    ds 8 ss
.    ds o a
.    ds d- d\h'-1'\(ga
.    ds D- D\h'-1'\(hy
.    ds th \o'bp'
.    ds Th \o'LP'
.    ds ae ae
.    ds Ae AE
.\}
.rm #[ #] #H #V #F C
.\" ========================================================================
.\"
.IX Title "OVDB 5"
.TH OVDB 5 "2018-03-18" "INN 2.6.3" "InterNetNews Documentation"
.\" For nroff, turn off justification.  Always turn off hyphenation; it makes
.\" way too many mistakes in technical documents.
.if n .ad l
.nh
.SH "NAME"
ovdb \- Overview storage method for INN
.SH "DESCRIPTION"
.IX Header "DESCRIPTION"
The ovdb overview is a storage method that uses the Berkeley\ \s-1DB\s0
library to store overview data.  It requires version 4.4 or later of
the Berkeley\ \s-1DB\s0 library (4.7+ is recommended because older versions
suffer from various issues).
.PP
The ovdb overview method makes use of the full
transaction/logging/locking functionality of the
Berkeley\ \s-1DB\s0 environment.  Berkeley\ \s-1DB\s0 may be downloaded from
<http://www.oracle.com/technetwork/database/database\-technologies/berkeleydb/overview/index.html>
and is needed to build the ovdb backend.
.SH "UPGRADING"
.IX Header "UPGRADING"
There are several versions of the ovdb storage method:
.IP "\(bu" 2
Version 1, the initial version shipped with \s-1INN\s0\ 2.3.0 up to \s-1INN\s0\ 2.3.5.
.IP "\(bu" 2
Version 2, with improved performance, since \s-1INN\s0\ 2.4.0.
.IP "\(bu" 2
Version 3, corresponding to version 2 with compression enabled, starting
with \s-1INN\s0\ 2.5.0.
.PP
If you have a database created with a previous version of ovdb,
your database will need to be upgraded using \fBovdb_init\fR.  See the
\&\fIovdb_init\fR\|(8) man page for upgrade instructions, as well as the
\&\s-1COMPRESSION\s0 section below.
.PP
Note that when the Berkeley\ \s-1DB\s0 library is updated to a newer version,
the ovdb database also needs being upgraded.
.SH "INSTALLATION"
.IX Header "INSTALLATION"
If the Berkeley\ \s-1DB\s0 library is found at configure time, \s-1INN\s0 will be
built with Berkeley\ \s-1DB\s0 support unless the \fB\-\-without\-bdb\fR flag is
explicitly passed to configure.  By default, configure will search for
Berkeley\ \s-1DB\s0 in standard locations; there will be a message in the
configure output indicating the pathname that will be used.
.PP
You can override this pathname by adding a path to the option, for
instance \fB\-\-with\-bdb=/usr/BerkeleyDB.4.4\fR.  This directory
is expected to have subdirectories \fIinclude\fR and \fIlib\fR (\fIlib32\fR
and \fIlib64\fR are also checked), containing respectively \fIdb.h\fR, and
the library itself.  In case non-standard paths to the Berkeley\ \s-1DB\s0
libraries are used, one or both of the options \fB\-\-with\-bdb\-include\fR
and \fB\-\-with\-bdb\-lib\fR can be given to configure with a path.
.PP
The ovdb database may take up more disk space for a given spool
than the other overview methods.  Plan on needing at least 1.1\ \s-1KB\s0
for every article in your spool (not counting crossposts).  So, if
you have 5 million articles, you'll need at least 5.5\ \s-1GB\s0 of disk
space for ovdb.  With compression enabled, this estimate changes to
0.7\ \s-1KB\s0 per article.  See the \s-1COMPRESSION\s0 section below.  Plus,
you'll need additional space for transaction logs: at least 100\ \s-1MB.\s0
By default, the transaction logs go in the same directory as the database.
To improve performance, they can be placed on a different disk \-\-\ see the \s-1DB_CONFIG\s0 section.
.SH "CONFIGURATION"
.IX Header "CONFIGURATION"
To enable the ovdb overview method, set the \fIovmethod\fR parameter in
\&\fIinn.conf\fR to \f(CW\*(C`ovdb\*(C'\fR.  The ovdb database is stored in the directory
specified by the \fIpathoverview\fR parameter in \fIinn.conf\fR.  This is
the \f(CW\*(C`DB_HOME\*(C'\fR directory.  To start out, this directory should be empty
(other than an optional \fI\s-1DB_CONFIG\s0\fR file; see \s-1DB_CONFIG\s0 for details),
and \fBinnd\fR (or \fBmakehistory\fR) will create the files as necessary in
that directory.  Also, make sure the directory is owned by the news user.
.PP
Other parameters for configuring ovdb are in the \fIovdb.conf\fR
configuration file.  The following parameters can be set in that file:
.IP "\fIcompress\fR" 4
.IX Item "compress"
If \s-1INN\s0 was compiled with zlib, and this \fIcompress\fR parameter is true,
ovdb will compress overview records that are longer than 600 bytes.
See the \s-1COMPRESSION\s0 section below.
.IP "\fIcachesize\fR" 4
.IX Item "cachesize"
Size of the memory pool cache, in kilobytes.  The cache will have a
backing store file in the \s-1DB\s0 directory which will be at least as big.
In general, the bigger the cache, the better.  Use \f(CW\*(C`ovdb_stat \-m\*(C'\fR
to see cache hit percentages.  To make a change of this parameter take
effect, shut down and restart \s-1INN \s0(be sure to kill all of the \fBnnrpd\fR
processes when shutting down).  Default is \f(CW8000\fR (\s-1KB\s0), which is adequate
for small to medium-sized servers.  Large servers will probably need
at least \f(CW20000\fR (\s-1KB\s0).
.IP "\fIncache\fR" 4
.IX Item "ncache"
Number of regions across which to split the cache.  The region size
is equal to \fIcachesize\fR divided by \fIncache\fR.  Default is \f(CW1\fR for
\&\fIncache\fR, that is to say the cache will be allocated contiguously
in memory.
.IP "\fInumdbfiles\fR" 4
.IX Item "numdbfiles"
Overview data is split between this many files.  Currently, \fBinnd\fR will
keep all of the files open, so don't set this too high or \fBinnd\fR may run
out of file descriptors.  \fBnnrpd\fR only opens one at a time, regardless.
May be set to one, or just a few, but only do that if your \s-1OS\s0 supports
large (>\ 2\ \s-1GB\s0) files.  Changing this parameter has no effect on an
already-established database.  Default is \f(CW32\fR.
.IP "\fItxn_nosync\fR" 4
.IX Item "txn_nosync"
If txn_nosync is set to false, Berkeley\ \s-1DB\s0 flushes the log after every
transaction.  This minimizes the number of transactions that may be lost
in the event of a crash, but results in significantly degraded
performance.  Default is true.
.IP "\fIuseshm\fR" 4
.IX Item "useshm"
If \fIuseshm\fR is set to true, Berkeley\ \s-1DB\s0 will use shared memory instead of
mmap for its environment regions (cache, lock, etc).  With some platforms,
this may improve performance.  Default is false.
.IP "\fIshmkey\fR" 4
.IX Item "shmkey"
Sets the shared memory key used by Berkeley\ \s-1DB\s0 when \fIuseshm\fR is true.
Berkeley\ \s-1DB\s0 will create several (usually 5) shared memory segments, using
sequentially numbered keys starting with \f(CW\*(C`shmkey\*(C'\fR.  Choose a key that does
not conflict with any existing shared memory segments on your system.
Default is \f(CW6400\fR.
.IP "\fIpagesize\fR" 4
.IX Item "pagesize"
Sets the page size for the \s-1DB\s0 files (in bytes).  Must be a power
of 2.  Best choices are \f(CW4096\fR or \f(CW8192\fR.  The default is \f(CW8192\fR.
Changing this parameter has no effect on an already-established database.
.IP "\fIminkey\fR" 4
.IX Item "minkey"
Sets the minimum number of keys per page.  See the Berkeley\ \s-1DB\s0
documentation for more information.  Default is based on page size
and whether compression is enabled:
.Sp
.Vb 2
\&   default_minkey = MAX(2, pagesize / 2600) if compress is false
\&   default_minkey = MAX(2, pagesize / 1500) if compress is true
.Ve
.Sp
The lowest allowed \fIminkey\fR is \f(CW2\fR.  Setting \fIminkey\fR higher than
the default is not recommended, as it will cause the databases to have
a lot of overflow pages.  Changing this parameter has no effect on an
already-established database.
.IP "\fImaxlocks\fR" 4
.IX Item "maxlocks"
Sets the Berkeley\ \s-1DB \s0\fIlk_max\fR parameter, which is the maximum number of
locks that can exist in the database at the same time.  Default is \f(CW4000\fR.
.IP "\fInocompact\fR" 4
.IX Item "nocompact"
The \fInocompact\fR parameter affects the behaviour of \fBexpireover\fR.
The \fBexpireover\fR function in ovdb can do its job in one of two
ways:  by simply deleting expired records from the database; or by
re-writing the overview records into a different location leaving out
the expired records.  The first method is faster, but it leaves 'holes'
that result in space that can not immediately be reused.  The second
method 'compacts' the records by rewriting them.
.Sp
If this parameter is set to \f(CW0\fR, \fBexpireover\fR will compact all
newsgroups; if set to \f(CW1\fR, \fBexpireover\fR will not compact any
newsgroups; and if set to a value greater than one, \fBexpireover\fR
will only compact groups that have less than that number of articles.
.Sp
Experience has shown that compacting has minimal effect (other than
making \fBexpireover\fR take longer) so the default is \f(CW1\fR.  This parameter
will probably be removed in the future.
.IP "\fIreadserver\fR" 4
.IX Item "readserver"
When the \fIreadserver\fR parameter is set to false, each \fBnnrpd\fR
process directly accesses the Berkeley\ \s-1DB\s0 environment.  The process
of attaching to the database (and detaching when finished) is fairly
expensive, and can result in high loads in situations when there are
lots of reader connections of relatively short duration.
.Sp
When the \fIreadserver\fR parameter is set to true, the \fBnnrpd\fR processes
will access overview via a helper server (\fBovdb_server\fR \-\-\ which
is started by \fBovdb_init\fR).  All ovdb reads will then be funnelled
through a single process with a cleaner interface to the underlying
Berkeley\ \s-1DB\s0 database.  This will result in cleaner shutdowns for the
database, improving stability and avoiding deadlocks, timing issues and
corrupted databases.  That's why you should try to set this parameter to
true if you are experiencing any instability in the ovdb overview method.
.Sp
Default value is true.
.IP "\fInumrsprocs\fR" 4
.IX Item "numrsprocs"
This parameter is only used when \fIreadserver\fR is true.  It sets the
number of \fBovdb_server\fR processes.  As each \fBovdb_server\fR can process
only one transaction at a time, running more servers can improve reader
response times.  Default is \f(CW5\fR.
.IP "\fImaxrsconn\fR" 4
.IX Item "maxrsconn"
This parameter is only used when \fIreadserver\fR is true.  It sets a
maximum number of readers that a given \fBovdb_server\fR process will
serve at one time.  This means the maximum number of readers for all
of the \fBovdb_server\fR processes is (\fInumrsprocs\fR * \fImaxrsconn\fR).
This does \fInot\fR limit the actual number of readers, since \fBnnrpd\fR
will fall back to opening the database directly if it can't connect to
an \fBovdb_server\fR.  Default is \f(CW0\fR, which means an unlimited number
of connections is allowed.
.SH "COMPRESSION"
.IX Header "COMPRESSION"
The ovdb storage method has the ability to compress overview data
before it is stored into the database.  In addition to consuming less disk
space, compression keeps the average size of the database keys smaller.
This in turn increases the average number of keys per page, which can
significantly improve performance and also helps keep the database more
compact.  This feature requires that \s-1INN\s0 be built with zlib.  Only records
larger than 600 bytes get compressed, because that is the point at which
compression starts to become significant.
.PP
If compression is not enabled (either from the \fIcompress\fR option in
\&\fIovdb.conf\fR or \s-1INN\s0 was not built with zlib support), the database
will be backward compatible with older versions of ovdb.  However,
if compression is enabled, the database is marked with a newer version
that will prevent older versions of ovdb from opening the database.
.PP
You can upgrade an existing database to use compression simply by setting
\&\fIcompress\fR to true in \fIovdb.conf\fR.  Note that existing records in the
database will remain uncompressed; only new records added after enabling
compression will be compressed.
.PP
If you disable compression on a database that previously had it enabled,
new records will be stored uncompressed, but the database will still be
incompatible with older versions of ovdb (and will also be incompatible
with this version of ovdb if \s-1INN\s0 was not built with zlib support).
So to downgrade to a completely uncompressed database, you will have
to rebuild the database using \fBmakehistory\fR.
.SH "DB_CONFIG"
.IX Header "DB_CONFIG"
A file called \fI\s-1DB_CONFIG\s0\fR may be placed in the database directory
(\fIpathoverview\fR in \fIinn.conf\fR) to customize where the various database
files and transaction logs are written.  By default, all of the files
are written in the \f(CW\*(C`DB_HOME\*(C'\fR directory.  One way to improve performance
is to put the transaction logs on a different disk.  To do this, put:
.PP
.Vb 1
\&    DB_LOG_DIR /path/to/logs
.Ve
.PP
in the \fI\s-1DB_CONFIG\s0\fR file.  If the pathname you give starts with a \f(CW\*(C`/\*(C'\fR, it is
treated as an absolute path; otherwise, it is relative to the \f(CW\*(C`DB_HOME\*(C'\fR
directory.  Make sure that any directories you specify exist and have
proper ownership/mode before starting \s-1INN,\s0 because they won't be created
automatically.  Also, don't change the \fI\s-1DB_CONFIG\s0\fR file while anything that
uses ovdb is running.
.PP
Another thing that you can do with this file is to split the overview
database across multiple disks.  In the \fI\s-1DB_CONFIG\s0\fR file, you can list
directories that Berkeley\ \s-1DB\s0 will search when it goes to open a database.
.PP
For example, let's say that you have \fIpathoverview\fR set to
\&\fI/mnt/overview\fR and you have four additional file systems created
on \fI/mnt/ovX\fR.  You would create a file \fI/mnt/overview/DB_CONFIG\fR
containing the following lines:
.PP
.Vb 5
\&    set_data_dir /mnt/overview
\&    set_data_dir /mnt/ov1
\&    set_data_dir /mnt/ov2
\&    set_data_dir /mnt/ov3
\&    set_data_dir /mnt/ov4
.Ve
.PP
Distribute your \fIovNNNNN\fR files into the four filesystems (say, 8 each).
When called upon to open a database file, the db library will look for it
in each of the specified directories (in order).  If said file is not
found, one will be created in the first of those directories.
.PP
Whenever you change \fI\s-1DB_CONFIG\s0\fR or move database files around, make
sure all news processes that use the database are shut down first
(including \fBnnrpd\fR processes).
.PP
The \fI\s-1DB_CONFIG\s0\fR functionality is part of Berkeley\ \s-1DB\s0 itself,
rather than something provided by ovdb.  See the Berkeley\ \s-1DB\s0
documentation for complete details for the version of Berkeley\ \s-1DB\s0
that you're running.
.SH "RUNNING"
.IX Header "RUNNING"
When starting the news system, \fBrc.news\fR will invoke the \fBovdb_init\fR
program.  See the \fIovdb_init\fR\|(8) man page for information about the tasks
it performs.  \fBovdb_init\fR must be run before using the database.
.PP
And when stopping \s-1INN, \s0\fBrc.news\fR kills the \fBovdb_monitor\fR processes after
the other \s-1INN\s0 processes have been shut down.
.SH "DIAGNOSTICS"
.IX Header "DIAGNOSTICS"
Problems relating to ovdb are logged to \fInews.err\fR with \f(CW\*(C`OVDB\*(C'\fR in
the error message.
.PP
\&\s-1INN\s0 programs that use overview will fail to start up if the
\&\fBovdb_monitor\fR processes aren't running.  Be sure to run \fBovdb_init\fR
before running anything that accesses overview.
.PP
Also, \s-1INN\s0 programs that use overview will fail to start up if the user
running them is not the news user.
.PP
If a program accessing the database crashes, or otherwise exits uncleanly,
it might leave a stale lock in the database.  This lock could cause other
processes to deadlock on that stale lock.  To fix this, shut down all news
processes (using \f(CW\*(C`kill \-9\*(C'\fR if necessary) and then restart.  \fBovdb_init\fR
should perform a recovery operation which will remove the locks and repair
damage caused by killing the deadlocked processes.
.SH "FILES"
.IX Header "FILES"
.IP "\fIpathetc\fR/inn.conf" 4
.IX Item "pathetc/inn.conf"
The \fIovmethod\fR and \fIpathoverview\fR parameters are relevant to ovdb.
.IP "\fIpathetc\fR/ovdb.conf" 4
.IX Item "pathetc/ovdb.conf"
Optional configuration file for tuning.  See \s-1CONFIGURATION\s0 above.
.IP "\fIpathoverview\fR" 4
.IX Item "pathoverview"
Directory where the database goes.  Berkeley\ \s-1DB\s0 calls it the
\&\f(CW\*(C`DB_HOME\*(C'\fR directory.
.IP "\fIpathoverview\fR/DB_CONFIG" 4
.IX Item "pathoverview/DB_CONFIG"
Optional file to configure the layout of the database files.
.IP "\fIpathrun\fR/ovdb.sem" 4
.IX Item "pathrun/ovdb.sem"
A file that gets locked by every process that is accessing the database.
This is used by \fBovdb_init\fR to determine whether the database is active
or quiescent.
.IP "\fIpathrun\fR/ovdb_monitor.pid" 4
.IX Item "pathrun/ovdb_monitor.pid"
Contains the process \s-1ID\s0 of \fBovdb_monitor\fR.
.SH "TO DO"
.IX Header "TO DO"
Implement a way to limit how many databases can be open at once (to reduce
file descriptor usage); maybe using something similar to the cache code in
legacy \fIov3.c\fR file.
.SH "HISTORY"
.IX Header "HISTORY"
Written by Heath Kehoe <hakehoe@avalon.net> for InterNetNews.
.PP
\&\f(CW$Id:\fR ovdb.pod 10241 2018\-02\-04 15:38:19Z iulius $
.SH "SEE ALSO"
.IX Header "SEE ALSO"
\&\fIinn.conf\fR\|(5), \fIinnd\fR\|(8), \fImakehistory\fR\|(8), \fInnrpd\fR\|(8), \fIovdb_init\fR\|(8),
\&\fIovdb_monitor\fR\|(8), \fIovdb_stat\fR\|(8).
.PP
Berkeley\ \s-1DB\s0 documentation:  in the \fIdocs\fR directory of the Berkeley\ \s-1DB\s0 source distribution, or on the Oracle Berkeley\ \s-1DB\s0 web page
(<http://www.oracle.com/technetwork/database/database\-technologies/berkeleydb/overview/index.html>).
